@* @model IEnumerable<rapid.core.app.Models.PatientAdmission> *@
@* @model rapid.core.app.Models.DashboardViewModel *@
@model DashboardViewModel
@{
    ViewData["Title"] = "Home Page";
}

<div class="container-fluid py-3">
    <div class="row g-3">

        <div class="col-12">
            <div id="surgeCard" class="card p-3">
                @* <div class="d-flex justify-content-between mb-2">
                    <div id="surgeLabel" class="fw-bold text-success">
                        <i class="fa-solid fa-shield-halved me-2"></i>
                        Normal Operations
                    </div>
                    <div id="surgePercent">0%</div>
                </div> *@
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div class="align-items-center d-flex justify-content-between w-100">
                        <div id="surgeLabel" class="fw-bold text-success fs-4">
                            <i class="fa-solid fa-shield-halved me-2"></i>
                            Normal Operations
                        </div>

                        <!-- NEW: patient counts beside label -->
                        <div class="d-flex gap-2 mt-1 flex-wrap">
                            <span class="badge badge-dark2">
                                <i class="fa-solid fa-bed-pulse me-1 text-info"></i>
                                Inpatient: <span id="surgeInpatient">0</span>
                            </span>

                            <span class="badge badge-dark2">
                                <i class="fa-solid fa-truck-medical me-1 text-warning"></i>
                                Incoming: <span id="surgeIncoming">0</span>
                            </span>
                        </div>
                    </div>
                </div>
                <div class="progress">
                    <div id="surgeBar" class="progress-bar bg-info"
                         role="progressbar"
                         style="width: 0%"></div>
                    @* <div class="progress-bar" style="width:65%"></div> *@
                </div>
            </div>
        </div>

        <!-- Left -->
        <div class="col-12 col-lg-6">

            <div id="staffReqFeed" class="card p-3 mb-3">
                <div class="fw-bold d-flex align-items-center gap-2">
                    <i class="fa-solid fa-user-plus text-danger"></i>
                    <div class="fw-bold">Staff Demand</div>
                </div>

                <div id="staffReqHiddenState" class="empty" style="display:none;">
                    Staffing requirements will appear during surge conditions.
                </div>

                <div id="staffReqFeedController">
                    <div class="progress mt-2">
                        <div id="staffReqBar"
                             class="progress-bar req-bar-danger"
                             style="width:0%"></div>
                    </div>

                    <div id="staffReqNotifiedList" class="muted small mt-1"></div>
                    <!-- Nurses -->
                    <div class="mt-2 mb-1 d-flex align-items-center gap-2">
                        <i class="fa-solid fa-user-nurse text-info"></i>
                        <div class="label">Nurses</div>
                        <div class="muted ms-auto">
                            <span id="reqFilledNurse">0</span>/<span id="reqTotalNurse">0</span>
                        </div>
                    </div>
                    <div id="reqEmptyNurse" class="empty">No nurse requirements</div>
                    <div id="reqListNurse" class="mt-1"></div>

                    @* <hr class="my-3" />

                    <!-- Doctors -->
                    <div class="mt-2 mb-1 d-flex align-items-center gap-2">
                        <i class="fa-solid fa-user-doctor text-warning"></i>
                        <div class="label">Doctors</div>
                        <div class="muted ms-auto">
                            <span id="reqFilledDoctor">0</span>/<span id="reqTotalDoctor">0</span>
                        </div>
                    </div>
                    <div id="reqEmptyDoctor" class="empty">No doctor requirements</div>
                    <div id="reqListDoctor" class="mt-1"></div> *@
                </div>
            </div>

            @* <div id="erFeedCard" class="card p-3">
                <div class="d-flex justify-content-between mb-3">
                    <div class="fw-bold">ER Admission Feed</div>
                    <div class="muted">
                        <span id="recentCount">@Model.Patients.Count()</span> recent
                    </div>
                </div>


                <div id="feedScrollContainer">
                    <section id="patientsContainer">
                        @if (!Model.Patients.Any())
                        {
                            <div id="emptyState" class="empty">No recent admissions</div>
                        }
                        else
                        {
                            foreach (var patient in Model.Patients)
                            {
                                @await Html.PartialAsync("_PatientCard", patient)
                            }
                        }
                    </section>
                </div>



                <div class="d-flex gap-2 mt-1">
                    <div class="muted font-monospace">Total Rooms: <span id="roomsTotal"></span></div>
                    <div class="muted font-monospace">Rooms Occupied: <span id="roomsOccupied"></span></div>
                    <div class="muted font-monospace">Available Rooms: <span id="roomsAvailable"></span></div>
                </div>
            </div> *@

        </div>

        <!-- RIGHT -->
        <div class="col-12 col-lg-6">

            <div id="staffFeedCard" class="card p-3 mb-3">
                @* <div class="d-flex justify-content-between mb-3">
                    <div class="fw-bold">Staff Availability</div>

                    <div class="muted">
                        @(Model.Staff.Count(s => s.Status == "available" || s.Status == "on_duty"))
                        / @Model.Staff.Count() ready
                    </div>

                </div> *@

                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="fw-bold d-flex align-items-center gap-2">
                        <i class="fa-solid fa-user-check text-danger"></i>
                        <div class="fw-bold">Staff Response</div>
                    </div>

                    <div class="muted small d-flex gap-3 align-items-center">
                        <span>
                            <span class="text-warning fw-semibold" id="availPending">0</span> pending
                        </span>

                        <span>
                            <span class="text-success fw-semibold" id="availConfirmed">0</span> confirmed
                        </span>

                        <span>
                            <span class="text-danger fw-semibold" id="availDeclined">0</span> declined
                        </span>

                        <span id="availNegotiatingWrap" class="d-none">
                            <i class="fa-solid fa-robot me-1 text-info"></i>
                            <span class="text-info fw-semibold" id="availNegotiating">0</span> negotiating
                        </span>
                    </div>
                </div>


                <div id="staffFeedScrollContainer">
                    @foreach (var staff in Model.Staff.Where(s => s.Role == "nurse"))
                    {
                    @await Html.PartialAsync("_StaffCard", staff, new ViewDataDictionary(ViewData) {
                            ["Mode"] = "availability",
                            ["Decision"] = rapid.core.app.Services.StaffCallDecisionStore.GetDecision(staff.Id)
                       })
                    }
                </div>
            </div>

            @* <div class="card p-3">
                <div class="d-flex justify-content-between">
                    <div class="fw-bold">AI Negotiations</div>
                    <div class="muted">0 pending</div>
                </div>
                <div class="empty">No active negotiations</div>
            </div> *@

        </div>

    </div>
</div>

@section Scripts {
    <script>
        (function () {
          try {
            const $ = (id) => document.getElementById(id);

            // ------------------------------------------------------------
            // 0) Grab elements early + always hide staff list on load
            // ------------------------------------------------------------
            const availabilityWrap = $('staffFeedScrollContainer');
            const reqWrap = $('reqListNurse');

            if (availabilityWrap) availabilityWrap.style.display = 'none';

            // ------------------------------------------------------------
            // 1) Forecast helpers (VISUAL ONLY)  ✅ safe integration
            // ------------------------------------------------------------
            function calculateSurgePctFromPatients(inpatient, incoming) {
              const score = (inpatient * 2) + (incoming * 4);
              return Math.min(140, Math.round(score));
            }

            // ✅ Visual update ONLY (does NOT touch staff workflow)
            function setSurgeVisual(pct) {
              const sBar = $('surgeBar');
              const sLabel = $('surgeLabel');

              if (sBar) {
                sBar.style.width = `${Math.min(100, pct)}%`;
                sBar.classList.remove('bg-info','bg-warning','bg-danger');
                if (pct >= 100) sBar.classList.add('bg-danger');
                else if (pct >= 60) sBar.classList.add('bg-warning');
                else sBar.classList.add('bg-info');
              }

              if (sLabel) {
                if (pct >= 100) {
                  sLabel.innerHTML = '<i class="fa-solid fa-shield-halved me-2"></i>SURGE OPERATIONS';
                  sLabel.classList.remove('text-success','text-warning');
                  sLabel.classList.add('text-danger');
                } else if (pct >= 60) {
                  sLabel.innerHTML = '<i class="fa-solid fa-shield-halved me-2"></i>ALERT OPERATIONS';
                  sLabel.classList.remove('text-success','text-danger');
                  sLabel.classList.add('text-warning');
                } else {
                  sLabel.innerHTML = '<i class="fa-solid fa-shield-halved me-2"></i>Normal Operations';
                  sLabel.classList.remove('text-warning','text-danger');
                  sLabel.classList.add('text-success');
                }
              }
            }

            // --- Patient counters + visual forecast update ---
            async function refreshPatientCounts() {
              try {
                const res = await fetch('/Home/GetPatientCounts', { cache: 'no-store' });
                const data = await res.json();

                const inpatient = (data && data.inpatient != null) ? data.inpatient : 0;
                const incoming  = (data && data.incoming  != null) ? data.incoming  : 0;

                const inpatientEl = $('surgeInpatient');
                const incomingEl  = $('surgeIncoming');

                if (inpatientEl) inpatientEl.textContent = inpatient;
                if (incomingEl)  incomingEl.textContent  = incoming;

                // ✅ VISUAL ONLY
                const pct = calculateSurgePctFromPatients(inpatient, incoming);
                setSurgeVisual(pct);
              } catch (e) {
                console.log('refreshPatientCounts failed', e);
              }
            }

            // ------------------------------------------------------------
            // 2) STAFF WORKFLOW (YOUR WORKING LOGIC — unchanged)
            // ------------------------------------------------------------
            let surgePct = 0;
            let requiredNurses = 0;
            let surgeTriggered = false;

            let forcedDeclineIds = new Set();
            const awaitingTimers = new WeakMap();

            function calculateRequiredNurses(pct) {
              if (pct < 100) return 0;
              const steps = Math.floor((pct - 100) / 20);
              return 6 + (steps * 2);
            }

            function getStaffId(card) {
              return card?.getAttribute('data-staff-id') || '';
            }

            function updateNurseEmptyState() {
              const empty = $('reqEmptyNurse');
              if (!reqWrap || !empty) return;

              const hasCards = reqWrap.children.length > 0;
              empty.textContent = (requiredNurses === 0) ? 'No nurse required' : 'No nurse confirmed yet';
              empty.style.display = hasCards ? 'none' : 'block';
            }

            function setDecisionBadge(card, decision) {
              card.dataset.decision = decision;

              const badge = card.querySelector('.decision-badge');
              if (!badge) return;

              badge.classList.remove(
                'bg-secondary','bg-success','bg-danger','bg-info','bg-warning',
                'text-white','text-black'
              );

              if (decision === 'confirmed') {
                badge.textContent = 'Confirmed';
                badge.classList.add('bg-success','text-white');
              } else if (decision === 'accepted') {
                badge.textContent = 'Accepted';
                badge.classList.add('bg-success','text-white');
              } else if (decision === 'declined') {
                badge.textContent = 'Declined';
                badge.classList.add('bg-danger','text-white');
              } else if (decision === 'negotiating') {
                badge.textContent = 'Negotiating…';
                badge.classList.add('bg-info','text-black');
              } else if (decision === 'awaiting') {
                badge.textContent = 'Awaiting';
                badge.classList.add('bg-warning','text-black');
              } else {
                badge.textContent = 'Pending';
                badge.classList.add('bg-secondary','text-white');
              }
            }

            function setButtonsEnabled(card, enabled) {
              card.querySelectorAll('button[data-action]').forEach(btn => {
                btn.disabled = !enabled;
              });
            }

            function removeButtons(card) {
              card.querySelectorAll('.action-confirm, .action-decline, button[data-action]').forEach(b => b.remove());
              const btnRow = card.querySelector('.d-flex.gap-2.mt-3');
              if (btnRow && btnRow.querySelectorAll('button').length === 0) btnRow.remove();
            }

            function updateAvailabilityHeader() {
              const p = $('availPending');
              const c = $('availConfirmed');
              const d = $('availDeclined');
              const n = $('availNegotiating');
              const nWrap = $('availNegotiatingWrap');

              if (!surgeTriggered) {
                if (p) p.textContent = '0';
                if (c) c.textContent = '0';
                if (d) d.textContent = '0';
                if (n) n.textContent = '0';
                if (nWrap) nWrap.classList.add('d-none');
                return;
              }

              let pending = 0, declined = 0, negotiating = 0, awaiting = 0, accepted = 0;

              if (availabilityWrap) {
                availabilityWrap.querySelectorAll('.staff-card').forEach(card => {
                  const decision = (card.dataset.decision || 'pending').toLowerCase();
                  if (decision === 'declined') declined++;
                  else if (decision === 'negotiating') negotiating++;
                  else if (decision === 'awaiting') awaiting++;
                  else if (decision === 'accepted') accepted++;
                  else pending++;
                });
              }

              const confirmed = reqWrap
                ? reqWrap.querySelectorAll('.staff-card[data-decision="confirmed"]').length
                : 0;

              if (p) p.textContent = String(pending + awaiting + accepted);
              if (c) c.textContent = String(confirmed);
              if (d) d.textContent = String(declined);
              if (n) n.textContent = String(negotiating);
              if (nWrap) nWrap.classList.toggle('d-none', negotiating === 0);
            }

            function cancelAutoResolve(card) {
              const t = awaitingTimers.get(card);
              if (t) clearTimeout(t);
              awaitingTimers.delete(card);
            }

            function scheduleAutoResolve(card) {
              if (!card) return;
              if ((card.dataset.decision || '').toLowerCase() !== 'awaiting') return;
              if (awaitingTimers.has(card)) return;

              const id = getStaffId(card);
              const delay = 2000 + Math.floor(Math.random() * 4000);

              const timer = setTimeout(() => {
                awaitingTimers.delete(card);
                if (!document.body.contains(card)) return;
                if ((card.dataset.decision || '').toLowerCase() !== 'awaiting') return;

                if (forcedDeclineIds.has(id)) {
                  markDeclined(card);
                  return;
                }

                setDecisionBadge(card, 'accepted');
                setButtonsEnabled(card, true);
                updateAvailabilityHeader();
              }, delay);

              awaitingTimers.set(card, timer);
            }

            function updateProgressUI() {
              if (!reqWrap) return;

              const confirmed = reqWrap.querySelectorAll('.staff-card[data-decision="confirmed"]').length;

              if ($('reqTotalNurse')) $('reqTotalNurse').textContent = requiredNurses;
              if ($('reqFilledNurse')) $('reqFilledNurse').textContent = confirmed;

              const pct = requiredNurses === 0 ? 0 : Math.min(100, Math.round((confirmed / requiredNurses) * 100));
              const bar = $('staffReqBar');
              if (bar) bar.style.width = `${pct}%`;

              const notifiedList = $('staffReqNotifiedList');
              if (notifiedList) {
                const names = Array.from(reqWrap.querySelectorAll('.staff-card[data-decision="confirmed"] .fw-bold'))
                  .map(x => (x.textContent || '').trim())
                  .filter(Boolean)
                  .join(', ');
                notifiedList.innerHTML = names ? `Confirmed nurses: <b>${names}</b>` : 'Confirmed nurses: —';
              }

              updateNurseEmptyState();
              updateAvailabilityHeader();
            }

            function moveToRequirements(card) {
              if (!card || !reqWrap) return;

              cancelAutoResolve(card);
              forcedDeclineIds.delete(getStaffId(card));

              card.remove();
              removeButtons(card);
              setDecisionBadge(card, 'confirmed');
              reqWrap.appendChild(card);

              updateProgressUI();
            }

            function markDeclined(card) {
              if (!card) return;

              cancelAutoResolve(card);
              forcedDeclineIds.delete(getStaffId(card));

              setDecisionBadge(card, 'declined');
              setButtonsEnabled(card, false);

              updateProgressUI();
            }

            availabilityWrap?.addEventListener('click', (e) => {
              const btn = e.target.closest('button[data-action]');
              if (!btn) return;

              const action = btn.getAttribute('data-action');
              const card = btn.closest('.staff-card');
              if (!card) return;

              const decision = (card.dataset.decision || '').toLowerCase();

              if (action === 'confirm' && (decision === 'awaiting' || decision === 'accepted')) {
                moveToRequirements(card);
              }

              if (action === 'decline') {
                markDeclined(card);
              }
            });

            function beginNegotiation() {
              if (!availabilityWrap) return;

              forcedDeclineIds = new Set();
              const cards = Array.from(availabilityWrap.querySelectorAll('.staff-card'));

              cards.forEach(card => {
                setDecisionBadge(card, 'negotiating');
                setButtonsEnabled(card, false);
                cancelAutoResolve(card);
              });
              updateAvailabilityHeader();

              setTimeout(() => {
                const eligible = cards.slice();
                const declineCount = Math.min(eligible.length, 1 + Math.floor(Math.random() * 2));

                for (let i = eligible.length - 1; i > 0; i--) {
                  const j = Math.floor(Math.random() * (i + 1));
                  [eligible[i], eligible[j]] = [eligible[j], eligible[i]];
                }

                eligible.slice(0, declineCount).forEach(card => forcedDeclineIds.add(getStaffId(card)));

                cards.forEach(card => {
                  if ((card.dataset.decision || '').toLowerCase() === 'negotiating') {
                    setDecisionBadge(card, 'awaiting');
                    setButtonsEnabled(card, true);
                    scheduleAutoResolve(card);
                  }
                });

                updateAvailabilityHeader();
              }, 1400);
            }

            function setSurgeUI(pct) {
              surgePct = pct;

              const showReq = pct >= 100;
              if ($('staffReqFeedController')) $('staffReqFeedController').style.display = showReq ? 'block' : 'none';
              if ($('staffReqHiddenState')) $('staffReqHiddenState').style.display = showReq ? 'none' : 'block';

              requiredNurses = calculateRequiredNurses(pct);

              if (availabilityWrap) {
                availabilityWrap.style.display = surgeTriggered ? 'block' : 'none';
              }

              updateProgressUI();
            }

            // ✅ DELEGATED trigger handler so it works even if button is in _Layout
            document.addEventListener('click', (e) => {
              const btn = e.target.closest('#btnTriggerSurge');
              if (!btn) return;

              surgeTriggered = true;
              if (availabilityWrap) availabilityWrap.style.display = 'block';

              setSurgeUI(120);
              beginNegotiation();
              updateAvailabilityHeader();
            });

            // ------------------------------------------------------------
            // INIT
            // ------------------------------------------------------------
            setInterval(refreshPatientCounts, 2000);
            refreshPatientCounts();

            setSurgeUI(0);
            updateAvailabilityHeader();

          } catch (err) {
            console.error('Index.cshtml script failed:', err);
          }
        })();
    </script>
}
