@* @model IEnumerable<rapid.core.app.Models.PatientAdmission> *@
@* @model rapid.core.app.Models.DashboardViewModel *@
@model DashboardViewModel
@{
    ViewData["Title"] = "Home Page";
}

<div class="container-fluid py-3">
    <div class="row g-3">

        <!-- LEFT -->
        <div class="col-12 col-lg-3">

            <div id="surgeCard" class="card p-3 mb-3">
                <div class="d-flex justify-content-between mb-2">
                    <div id="surgeLabel" class="fw-bold text-success">
                        <i class="fa-solid fa-shield-halved me-2"></i>
                        Normal Operations
                    </div>
                    <div id="surgePercent">0%</div>
                </div>
                <div class="progress">
                    <div id="surgeBar" class="progress-bar bg-info"
                         role="progressbar"
                         style="width: 0%"></div>
                    @* <div class="progress-bar" style="width:65%"></div> *@
                </div>
            </div>

            <div class="row g-3">
                <div class="col-6">
                    <div class="panel text-center">
                        <div class="label">Patients</div>
                        <div class="metric" id="statsPatients">0</div>
                    </div>
                </div>

                <div class="col-6">
                    <div class="panel text-center">
                        <div class="label">Waiting</div>
                        <div class="metric" id="statsWaiting">0</div>
                    </div>
                </div>

                <div class="col-6">
                    <div class="panel text-center alert-border">
                        <div class="label">Wait Time</div>
                        <div class="metric text-danger" id="statsWaitTime">0</div>
                        <div class="muted">min</div>
                    </div>
                </div>

                <div class="col-6">
                    <div class="panel text-center">
                        <div class="label">Velocity</div>
                        <div class="metric" id="statsVelocity">0</div>
                        <div class="muted">/hr</div>
                    </div>
                </div>
            </div>

            <div class="mt-4 mb-2 label">AI Agents</div>

            <div class="agent">
                <div class="d-flex justify-content-between">
                    <div><i class="fa-solid fa-brain me-2"></i>Analytics Agent</div>
                    <span class="dot-gray"></span>
                </div>
                <div class="muted">Monitoring ER admissions</div>
            </div>

            <div class="agent">
                <div class="d-flex justify-content-between">
                    <div><i class="fa-solid fa-users me-2"></i>Staffing Agent</div>
                    <span class="dot-gray"></span>
                </div>
                <div class="muted">Staff pool ready</div>
            </div>

            <div class="agent">
                <div class="d-flex justify-content-between">
                    <div><i class="fa-solid fa-comments me-2"></i>Negotiator Agent</div>
                    <span class="dot-gray"></span>
                </div>
                <div class="muted">Awaiting assignments</div>
            </div>

            <div class="agent">
                <div class="d-flex justify-content-between">
                    <div><i class="fa-solid fa-network-wired me-2"></i>Orchestrator Agent</div>
                    <span class="dot"></span>
                </div>
                <div class="muted">System nominal</div>
            </div>

        </div>

        <!-- CENTER -->
        <div class="col-12 col-lg-6">

            <div id="staffReqFeed" class="card p-3 mb-3">
                <div class="d-flex justify-content-between">
                    <div class="fw-bold">Staffing Requirements</div>
                    <div class="muted">
                        <span id="reqFilledAll">0</span>/<span id="reqTotalAll">0</span>
                    </div>
                </div>

                <div id="staffReqFeedController">
                    <!-- Nurses -->
                    <div class="mt-2 mb-1 d-flex align-items-center gap-2">
                        <i class="fa-solid fa-user-nurse text-info"></i>
                        <div class="label">Nurses</div>
                        <div class="muted ms-auto">
                            <span id="reqFilledNurse">0</span>/<span id="reqTotalNurse">0</span>
                        </div>
                    </div>
                    <div id="reqEmptyNurse" class="empty">No nurse requirements</div>
                    <div id="reqListNurse" class="mt-1"></div>

                    <hr class="my-3" />

                    <!-- Doctors -->
                    <div class="mt-2 mb-1 d-flex align-items-center gap-2">
                        <i class="fa-solid fa-user-doctor text-warning"></i>
                        <div class="label">Doctors</div>
                        <div class="muted ms-auto">
                            <span id="reqFilledDoctor">0</span>/<span id="reqTotalDoctor">0</span>
                        </div>
                    </div>
                    <div id="reqEmptyDoctor" class="empty">No doctor requirements</div>
                    <div id="reqListDoctor" class="mt-1"></div>
                </div>
            </div>

            <div id="erFeedCard" class="card p-3">
                <div class="d-flex justify-content-between mb-3">
                    <div class="fw-bold">ER Admission Feed</div>
                    <div class="muted">
                        <span id="recentCount">@Model.Patients.Count()</span> recent
                    </div>
                </div>


                <div id="feedScrollContainer">
                    <section id="patientsContainer">
                        @if (!Model.Patients.Any())
                        {
                            <div id="emptyState" class="empty">No recent admissions</div>
                        }
                        else
                        {
                            foreach (var patient in Model.Patients)
                            {
                                @await Html.PartialAsync("_PatientCard", patient)
                            }
                        }
                        @* <div id="emptyState" class="empty" @(Model != null ? "style=\"display:none\"" : "")>No recent admissions</div> *@
                    </section>
                </div>



                <div class="d-flex gap-2 mt-1">
                    <div class="muted font-monospace">Total Rooms: <span id="roomsTotal"></span></div>
                    <div class="muted font-monospace">Rooms Occupied: <span id="roomsOccupied"></span></div>
                    <div class="muted font-monospace">Available Rooms: <span id="roomsAvailable"></span></div>
                </div>
            </div>

        </div>

        <!-- RIGHT -->
        <div class="col-12 col-lg-3">

            <div id="staffFeedCard" class="card p-3 mb-3">
                <div class="d-flex justify-content-between mb-3">
                    <div class="fw-bold">Staff Availability</div>

                    <div class="muted">
                        @(Model.Staff.Count(s => s.Status == "available" || s.Status == "on_duty"))
                        / @Model.Staff.Count() ready
                    </div>

                </div>


                <div id="staffFeedScrollContainer">
                    @foreach (var staff in Model.Staff)
                    {
                        <div class="staff mb-2">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <div class="fw-bold">@staff.Name</div>
                                    <div class="muted">@staff.Specialty</div>
                                </div>
                                <div>
                                    @if (staff.Status == "on_duty")
                                    {
                                        <span class="badge bg-success text-white">On Duty</span>
                                    }
                                    else if (staff.Status == "available")
                                    {
                                        <span class="badge bg-info text-black">Available</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary text-muted-foreground">Off Duty</span>
                                    }
                                </div>
                            </div>

                            <div class="muted d-flex align-items-center gap-2 mt-2 justify-content-between">
                                <div class="d-flex gap-2">
                                    <div class="muted">@staff.DistanceMinutes<span>m</span></div>
                                    <div class="muted">@staff.ResponseRate <span>resp</span></div>
                                </div>
                                <div>

                                    @foreach (var cert in staff.Certifications)
                                    {
                                        <span class="px-1.5 py-0.5 rounded bg-secondary text-[10px] text-muted-foreground">@cert</span>
                                    }

                                </div>
                            </div>
                        </div>
                    }
                </div>


            </div>

            <div class="card p-3">
                <div class="d-flex justify-content-between">
                    <div class="fw-bold">AI Negotiations</div>
                    <div class="muted">0 pending</div>
                </div>
                <div class="empty">No active negotiations</div>
            </div>

        </div>

    </div>
</div>

@section Scripts {
    <script>
        (function () {

          // ---------- DOM Helpers ----------
          const $ = (id) => document.getElementById(id);

          // ---------- Add Patient (your existing animation) ----------
          const addBtn = $('btnAddPatient');
          const container = $('patientsContainer');
          const emptyState = $('emptyState');
          const recentCountEl = $('recentCount');

          function timeAgo(fromDate) {
            const now = new Date();
            const diffMin = Math.floor((now - fromDate) / 60000);
            if (diffMin <= 0) return 'Just now';
            if (diffMin === 1) return 'a minute ago';
            return `${diffMin} minutes ago`;
          }

          function setNowIfMissing(card) {
            if (!card.dataset.addedAt) card.dataset.addedAt = new Date().toISOString();
          }

          function updatePerCardTimes() {
            const cards = container.querySelectorAll('.patient-card');
            cards.forEach(card => {
              setNowIfMissing(card);
              const added = new Date(card.dataset.addedAt);
              const label = card.querySelector('.added-time');
              if (label) label.textContent = timeAgo(added);
            });
          }

          function updateCounts() {
            recentCountEl.textContent = container.querySelectorAll('.patient-card').length;
          }

          function updateAllCards() {
            updatePerCardTimes();
            updateCounts();
          }

          function slideDown(el, duration = 300) {
            return new Promise(resolve => {
              el.style.removeProperty('display');
              let display = getComputedStyle(el).display;
              if (display === 'none') display = 'block';
              el.style.display = display;

              const targetHeight = el.scrollHeight + 'px';
              el.style.overflow = 'hidden';
              el.style.maxHeight = '0px';
              el.style.transition = `max-height ${duration}ms ease`;

              requestAnimationFrame(() => { el.style.maxHeight = targetHeight; });

              const cleanup = () => {
                el.style.removeProperty('max-height');
                el.style.removeProperty('overflow');
                el.style.removeProperty('transition');
                el.removeEventListener('transitionend', onEnd);
                resolve();
              };

              const fallback = setTimeout(() => {
                el.removeEventListener('transitionend', onEnd);
                cleanup();
              }, duration + 80);

              function onEnd(e) {
                if (e.propertyName === 'max-height') {
                  clearTimeout(fallback);
                  cleanup();
                }
              }
              el.addEventListener('transitionend', onEnd);
            });
          }

          async function addPatient() {
            try {
              if (addBtn) addBtn.disabled = true;

              const res = await fetch('@Url.Action("AddPatientCard", "Home")', {
                method: 'GET',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
              });
              if (!res.ok) throw new Error('Network response was not ok');

              const html = await res.text();
              if (emptyState) emptyState.style.display = 'none';

              const temp = document.createElement('template');
              temp.innerHTML = html.trim();
              const newCard = temp.content.firstElementChild;

              newCard.dataset.addedAt = new Date().toISOString();

              const inner = newCard.querySelector('.patient-card-inner');
              if (inner) inner.classList.remove('slide-in');

              container.insertBefore(newCard, container.firstElementChild);

              await slideDown(newCard, 300);
              await new Promise(r => setTimeout(r, 80));
              if (inner) requestAnimationFrame(() => inner.classList.add('slide-in'));

              updateAllCards();
            } catch (err) {
              console.error(err);
              alert('Failed to add patient. Please try again.');
            } finally {
              if (addBtn) addBtn.disabled = false;
            }
          }

          if (addBtn) {
            addBtn.addEventListener('click', (e) => {
              e.preventDefault();
              addPatient();
            });
          }

          // Reveal any server-seeded cards
          document.querySelectorAll('.patient-card[style*="display:none"]').forEach(card => {
            card.style.display = 'block';
            const inner = card.querySelector('.patient-card-inner');
            if (inner) inner.classList.add('slide-in');
            setNowIfMissing(card);
          });
          updateAllCards();
          setInterval(updateAllCards, 60 * 1000);

          // ---------- Staffing Requirements Renderer (per role) ----------
          function renderReqSection(stats, key, listId, emptyId, totalId, filledId, roleBadgeLabel) {
            const sect = stats[key] || {};
            const items = sect.items || [];
            const totalRequired = sect.totalRequired ?? 0;
            const totalFilled   = sect.totalFilled   ?? 0;

            $(totalId).textContent  = totalRequired;
            $(filledId).textContent = totalFilled;

            if (!items.length) {
              $(emptyId).style.display = 'block';
              $(listId).innerHTML = '';
              return { totalRequired, totalFilled };
            }

            $(emptyId).style.display = 'none';

            const rowHtml = items.map(it => {
              const pct = Math.max(0, Math.min(100, Math.round(it.coverage || 0)));
              let barClass = 'req-bar-danger';
              if (pct >= 100) barClass = 'req-bar-success';
              else if (pct >= 66) barClass = 'req-bar-warn';

              // return `
              //   <div class="mb-2 staffReqCard">
              //     <div class="d-flex justify-content-between align-items-center">
              //       <div>
              //         <span class="badge badge-dark2 me-2">${roleBadgeLabel}</span>
              //         <span class="badge bg-secondary">${it.group}</span>
              //       </div>
              //       <div class="muted font-monospace">${it.filled}/${it.required}</div>
              //     </div>
              //     <div class="progress mt-1">
              //       <div class="progress-bar ${barClass}" style="width:${pct}%"></div>
              //     </div>
              //   </div>
              // `;
              return `
                <div class="mb-2 staffReqCard">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <span class="badge badge-dark2 me-2">${roleBadgeLabel}</span>
                      <span class="badge bg-secondary">${it.group}</span>
                    </div>
                    <div class="muted font-monospace">${it.filled}/${it.required}</div>
                  </div>
                </div>
              `;
            }).join('');

            $(listId).innerHTML = rowHtml;
            return { totalRequired, totalFilled };
          }

          // ---------- Surge Gauge + Stats Poll ----------
          async function refreshStats() {
            const res = await fetch('/Home/GetStats', { cache: 'no-store' });
            if (!res.ok) return;
            const stats = await res.json();

            // Top metrics
            $('statsPatients').textContent  = stats.patients;
            $('statsWaiting').textContent   = stats.waiting;
            $('statsWaitTime').textContent  = stats.avgWait;
            $('statsVelocity').textContent  = stats.velocity;
            $('roomsTotal').textContent     = stats.rooms.total;
            $('roomsOccupied').textContent  = stats.rooms.occupied;
            $('roomsAvailable').textContent = stats.rooms.available;

            // Surge Gauge
            const gauge     = stats.surge.percent;
            const emergency = stats.surge.emergency;
            const level     = stats.surge.level;

            const bar     = $('surgeBar');
            const label   = $('surgeLabel');
            const percent = $('surgePercent');
            const card    = $('surgeCard');

            bar.style.width = `${gauge}%`;
            percent.textContent = `${gauge}%`;

            bar.classList.remove("bg-info", "bg-warning", "bg-orange", "bg-danger");
            card.classList.remove("flash-red", "alert-level", "critical-level");
            label.classList.remove("text-success", "text-warning", "text-danger");

            switch (level) {
              case "normal":
                bar.classList.add("bg-info");
                label.textContent = "Normal Operations";
                label.classList.add("text-success");
                break;
              case "alert":
                bar.classList.add("bg-warning");
                label.textContent = "Alert Operations";
                label.classList.add("text-warning");
                card.classList.add("alert-level");
                break;
              case "critical":
                bar.classList.add("bg-orange");
                label.textContent = "Critical Load";
                label.classList.add("text-danger");
                card.classList.add("critical-level");
                break;
              case "surge":
                bar.classList.add("bg-danger");
                label.textContent = `SURGE — ${emergency}`;
                label.classList.add("text-danger");
                card.classList.add("flash-red");
                break;
            }

            // ---------- ALWAYS render Requirements (Nurses & Doctors) ----------
            const n = renderReqSection(
              stats,
              'staffingRequirementsNurses',
              'reqListNurse', 'reqEmptyNurse',
              'reqTotalNurse', 'reqFilledNurse',
              'Nurse'
            );

            const d = renderReqSection(
              stats,
              'staffingRequirementsDoctors',
              'reqListDoctor', 'reqEmptyDoctor',
              'reqTotalDoctor', 'reqFilledDoctor',
              'Doctor'
            );

            $('reqTotalAll').textContent  = (n.totalRequired || 0) + (d.totalRequired || 0);
            $('reqFilledAll').textContent = (n.totalFilled   || 0) + (d.totalFilled   || 0);

            // ---------- Suggestions (only if the card exists) ----------
            const sDiv = $('staffingContent');
            if (sDiv) {
              const needN = stats.staffing?.need?.nurses  ?? 0;
              const needD = stats.staffing?.need?.doctors ?? 0;

              const norm = (x) => ({
                Id: (x?.Id ?? x?.id) ?? '',
                Name: (x?.Name ?? x?.name) ?? '',
                DistanceMinutes: (x?.DistanceMinutes ?? x?.distanceMinutes) ?? 0,
                ResponseRate: (x?.ResponseRate ?? x?.responseRate) ?? 0
              });

              const nurses  = (stats.suggestedStaff?.nurses  ?? []).map(norm);
              const doctors = (stats.suggestedStaff?.doctors ?? []).map(norm);

              sDiv.innerHTML = `
                <div>Emergency: <b>${stats.staffing?.emergency ?? '-'}</b> ·
                Level: <b>${(stats.surge?.level ?? '').toUpperCase()}</b></div>

                <div>Need → Nurses: <b>${needN}</b>, Doctors: <b>${needD}</b></div>
                <hr class="my-2"/>

                <div><b>Suggested Nurses:</b>
                  ${nurses.length ? nurses.map(n => `${n.Name} (${n.DistanceMinutes}m, ${Math.round(n.ResponseRate*100)}%)`).join(", ") : "—"}
                </div>
                <div><b>Suggested Doctors:</b>
                  ${doctors.length ? doctors.map(d => `${d.Name} (${d.DistanceMinutes}m, ${Math.round(d.ResponseRate*100)}%)`).join(", ") : "—"}
                </div>
              `;

              const btn = $('btnCallSuggested');
              if (btn) {
                const ids = [...nurses.map(n => n.Id), ...doctors.map(d => d.Id)].filter(Boolean);
                btn.disabled = ids.length === 0;
                btn.onclick = async () => {
                  if (!ids.length) return;
                  const r = await fetch('/Home/ActivateStaff', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(ids)
                  });
                  if (!r.ok) {
                    console.error('ActivateStaff failed', await r.text());
                    return;
                  }
                  await refreshStats();
                };
              }
            }
          }

          // First pull + poll every 5s
          refreshStats();
          setInterval(refreshStats, 5000);

        })();
    </script>
}